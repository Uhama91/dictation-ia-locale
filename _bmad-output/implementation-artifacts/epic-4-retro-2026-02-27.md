# Epic 4 Retrospective : Historique des dictées

**Date** : 2026-02-27
**Epic** : Epic 4 — Historique des dictées
**Stories** : 4.1, 4.2
**Status** : DONE

---

## Summary

Epic 4 delivered the dictation history feature: automatic session recording (SQLite with migrations) and a consultation UI with copy, save/unsave, delete, and audio playback. Implementation was done in two passes — the initial pass covered base functionality, and a second pass completed 3 missing acceptance criteria: write_mode badge (Chat/Pro/Code), post-processed text display with raw/treated toggle, and relative timestamps. A Gemini code review drove two quality improvements: DRY extraction of `writeModes.ts` shared config and decoupling `Display` trait from DB storage for write_mode. All FRs (FR15, FR16, FR17) are covered.

---

## Metrics

| Metric | Value |
|--------|-------|
| Stories completed | 2/2 (100%) |
| Tests added | 7 (history module) + 1 fix (tray.rs) |
| Total project tests | 137 (up from 129 post-Epic 1) |
| Bugs pré-existants corrigés | 3 (whisper_wrapper.c flash_attn, tray.rs write_mode, React unlisten promises) |
| Rework passes | 1 (ACs manquants corrigés en 2e passe) |
| Cross-LLM reviews | 1 (Gemini → 2 corrections) |

---

## Story Results

### Story 4.1 — Enregistrement automatique des sessions de dictée

- **Status** : DONE
- **ACs** : 3/3 PASS
- **Key work** : Migration 4 (`ALTER TABLE ADD COLUMN write_mode TEXT`), `save_transcription()` et `save_to_database()` mis à jour avec paramètre `write_mode: Option<String>`, passage du write_mode depuis `actions.rs`

### Story 4.2 — Consultation et copie depuis l'historique

- **Status** : DONE
- **ACs** : 4/4 PASS (après 2e passe)
- **Key work** :
  - Badge write_mode coloré (chat=bleu, pro=violet, code=vert) via `writeModes.ts` partagé
  - Timestamps relatifs (`Intl.RelativeTimeFormat`) avec tooltip absolu au hover
  - Toggle texte brut Whisper / texte traité final
  - Copie du texte traité (avec fallback sur texte brut)

---

## What Went Well

1. **Migration SQLite rétrocompatible** — colonne nullable `write_mode` ajoutée sans casser les entrées existantes
2. **Réutilisation de code existant** — `formatRelativeTime()` déjà implémenté dans `dateFormat.ts`, `WRITE_MODE_CONFIG` extrait et partagé
3. **Cross-LLM review appliquée** — Gemini a identifié le DRY violation et le couplage Display/DB, les deux ont été corrigés
4. **UX historique aboutie** — timestamps relatifs en français, badges colorés par mode, toggle brut/traité

## What Went Wrong

1. **ACs incomplets à la première passe** — Story 4.2 manquait 3 acceptance criteria (badge, texte traité, timestamps relatifs), nécessitant du rework
2. **Bugs pré-existants** — `whisper_wrapper.c` (flash_attn sur mauvais struct), `tray.rs` (write_mode manquant), React unlisten promises → écran blanc
3. **Zéro tests initialement** — résolu en session retro (7 tests ajoutés)
4. **Pas de story files BMAD** — les stories 4.1 et 4.2 n'ont pas de fichiers dédiés dans implementation-artifacts, contrairement à l'Epic 1
5. **Retros Epics 2 et 3 sautées** — perte de learnings intermédiaires

---

## Key Learnings

### L1 — Vérifier tous les ACs avant de marquer "done"
La Story 4.2 a été considérée "done" alors que 3 ACs n'étaient pas implémentés. Le rework aurait été évité en vérifiant systématiquement chaque AC.

### L2 — Les bugs pré-existants du fork continuent de surgir
3 bugs pré-existants découverts pendant l'Epic 4. Le fork Handy contient encore des surprises. Approche : les corriger de manière opportuniste plutôt qu'un audit massif.

### L3 — Le process BMAD ne doit pas être court-circuité
Sauter les story files et les retros fait gagner du temps à court terme mais on perd la traçabilité et les learnings. Les Epics 2 et 3 n'ont aucune documentation de leurs apprentissages.

### L4 — L'extraction DRY post-review est précieuse
La review Gemini a poussé à extraire `writeModes.ts` — un refactoring qui bénéficie immédiatement à deux composants et facilitera tout futur ajout de mode d'écriture.

---

## Technical Debt

| ID | Description | Severity | Status |
|----|-------------|----------|--------|
| TD-E4-1 | Pas de story files BMAD pour Epic 4 | LOW | ACCEPTED — ne pas rétroactivement créer |
| TD-E4-2 | Retros Epics 2 et 3 manquantes | LOW | ACCEPTED — learnings perdus |
| TD-E4-3 | Pas de tests frontend (React) | MEDIUM | KNOWN — pas de framework de test React en place |

---

## Previous Retro Follow-Through (Epic 1)

| Engagement Epic 1 | Status |
|---|---|
| L1 — Cross-LLM review obligatoire | ✅ Appliqué |
| L2 — Pattern dlsym + force_load | ✅ En place |
| L3 — Audit concurrence fork | ⏳ Opportuniste, pas d'audit dédié |
| TD-1 — STT latence whisper native | ✅ Résolu (commit 6eb3cbe) |
| TD-2 — Swift AX paste validé release | ⏳ Non confirmé |
| R5 — Test count croissant | ✅ 129 → 137 |

---

## Action Items

### Process
1. **Créer les story files BMAD avant implémentation** — Owner: Scrum Master
2. **Ne pas sauter les retros** — Owner: Ullie
3. **Vérifier tous les ACs avant "done"** — Owner: Dev agent

### Résolus en session
- ✅ Tests Epic 4 ajoutés (7 tests, 137 total)
- ✅ Fix `tray.rs` write_mode manquant

---

## Next Epic Preview

**Epic 5 : Onboarding, modèles et vie privée** (4 stories)
- 5.1 : Détection et téléchargement modèle Whisper
- 5.2 : Détection Ollama et fallback rules-only
- 5.3 : Onboarding permissions macOS
- 5.4 : Indicateur vie privée

Dépendances sur Epic 4 : minimales. Plan toujours valide, pas de changements significatifs nécessaires.

---

## Artifacts

| Artifact | Path |
|----------|------|
| Sprint Status | `_bmad-output/implementation-artifacts/sprint-status.yaml` |
| Epic 4 commit | `15c3bb5` |
| Tests commit | (à commiter) |
| This Retrospective | `_bmad-output/implementation-artifacts/epic-4-retro-2026-02-27.md` |
